name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options: [patch, minor, major]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push commits and create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo binaries
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-bin-

      - name: Install Tools
        run: |
          cargo install cargo-edit git-cliff
          
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Bump version
        run: |
          cargo set-version --bump ${{ github.event.inputs.bump }}
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          echo "NEW_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Changelog
        run: |
          git-cliff --tag v${{ env.NEW_VERSION }} --output CHANGELOG.md

      - name: Commit and Push
        run: |
          git add Cargo.toml Cargo.lock CHANGELOG.md
          git commit -m "chore: release v${{ env.NEW_VERSION }}"
          git tag -a v${{ env.NEW_VERSION }} -m "Release v${{ env.NEW_VERSION }}"
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          body_path: CHANGELOG.md # Uses the generated file as release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Crates.io
        run: cargo publish --token ${{ secrets.CRATES_TOKEN }}
